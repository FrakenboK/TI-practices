---
title: "Практическая работа №6. Исследование вредоносной активности в домене Windows"
author: "kobyakmihail@yandex.ru"
format: 
  md:
    output-file: README.md
---

## Цель работы

1. Закрепить навыки исследования данных журнала Windows Active Directory
2. Изучить структуру журнала системы Windows Active Directory
3. Зекрепить практические навыки использования языка программирования R для обработки данных
4. Закрепить знания основных функций обработки данных экосистемы `tidyverse` языка R

## Исходные данные

1.  Программное обеспечение Windows 11
2.  Интерпретатор языка R v4.5.1
3.  Rstudio IDE

## Общая ситуация

На протяжении долгого времени системные администраторы Доброй Организации замечали подозрительную активность в домене Windows, но конкретных доказательств компрометации сети найти не удавалось. К Вам в руки попал файл с выгрузкой данных из системы SIEM. Помогите выявить факты компрометации.

## Задание

Используя программный пакет `dplyr` языка программирования R провести анализ журналов и ответить на вопросы. 

## Подготовка к выполнению задания 

Произведем загрузку библиотек:

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(readr)

library(httr)
library(jsonlite)

library(dplyr)

library(xml2)
library(rvest)
```

## Шаги

### Подготовка данных

#### Импортируйте данные. Привести датасеты в вид "аккуратных данных", преобразовать типы столбцов в соответствии с типом данных. 

```{r}
if (!dir.exists("data")) {
    dir.create("data")
}

arch_url <- "https://storage.yandexcloud.net/iamcth-data/dataset.tar.gz"
filename <- "data/dataset.tar.gz"

download.file(
    url = arch_url,
    destfile = filename,
    mode = "wb",
    quiet = FALSE
)

untar(
  tarfile = filename,
  exdir = "data"
)

dataset_filename = "data/caldera_attack_evals_round1_day1_2019-10-20201108.json"

con <- file(dataset_filename, open = "r")
winlogs <- stream_in(con)
close(con)

webpage_url <- "https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor"
webpage <- read_html(webpage_url)
event_df <- html_table(webpage)[[1]]

```

#### Просмотрите общую структуру данных с помощью функции `glimpse()`

```{r}
glimpse(winlogs)
glimpse(event_df)
```

### Анализ

#### 1. Раскройте датафрейм избавившись от вложенных датафреймов. Для обнаружения таких можно использовать функцию `dplyr::glimpse()`, а для раскрытия вложенности – `tidyr::unnest()`. Обратите внимание, что при раскрытии теряются внешние названия колонок – это можно предотвратить если использовать параметр `tidyr::unnest(..., names_sep = )`

```{r}

for(i in 0:2) {
    winlogs_analysis <- names(winlogs)[map_lgl(winlogs, is.data.frame)]

    for (col in winlogs_analysis) {
        winlogs <- winlogs %>% unnest(all_of(col), names_sep = "_")
    }
}

glimpse(winlogs)
```

#### 2. Минимизируйте количество колонок в датафрейме – уберите колоки с единственным значением параметра.

```{r}
winlogs_minimized <- winlogs %>%
    select(
        where(
            ~ n_distinct(.) > 1
            )
    )

ncol(winlogs)
ncol(winlogs_minimized)
```

#### 3. Какое количество хостов представлено в данном датасете?

```{r}
winlogs %>% 
    distinct(winlog_computer_name) %>%
    count()
```

#### 4. Подготовьте датафрейм с расшифровкой Windows Event_ID, приведите типы данных к типу их значений

```{r}
event_df <- event_df %>%
    rename(
        current_event_id = `Current Windows Event ID`,
        legacy_event_id = `Legacy Windows Event ID`,
        criticality = `Potential Criticality`,
        summary = `Event Summary`
    ) %>%
    mutate(
        current_event_id = as.integer(current_event_id),
        legacy_event_id = as.integer(legacy_event_id)
    )

glimpse(event_df)
```

#### 5. Есть ли в логе события с высоким и средним уровнем значимости? Сколько их?

```{r}
logs_with_criticality <- winlogs %>%
    left_join(
        event_df,
        by = c("event_code" = "current_event_id")
    )

logs_with_criticality %>% select(event_code, criticality) %>% head(10) 

events_high <- logs_with_criticality %>%
    filter(criticality == "High") %>%
    summarise(
        count_high = n(),
    )

events_high

events_medium <- logs_with_criticality %>%
    filter(criticality == "Medium") %>%
    summarise(
        count_medium = n(),
    )

events_medium
```

Событий с критичностью `High` или `Medium` нет.

## Вывод

В данной работе мы научились анализировать логи Windows Active Directory