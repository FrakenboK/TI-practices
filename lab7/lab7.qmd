---
title: "Практическая работа №7. Использование технологии Yandex Query для анализа данных сетевой активности"
author: "kobyakmihail@yandex.ru"
format: 
  md:
    output-file: README.md
---

## Цель работы

1. Изучить возможности технологии Yandex Query для анализа структурированных наборов данных
2. Получить навыки построения аналитического пайплайна для анализа данных с помощью сервисов Yandex Cloud
3. Закрепить практические навыки использования SQL для анализа данных сетевой активности в сегментированной корпоративной сети

## Исходные данные

1.  Программное обеспечение Windows 11
2.  Интерпретатор языка R v4.5.1
3.  Rstudio IDE

## Общая ситуация

Вам стали доступны данные сетевой активности в корпоративной сети компании
XYZ. Данные хранятся в Yandex Object Storage. Проведите разведочный анализ
данных и ответьте на вопросы

## Задание

Используя сервис Yandex Query настроить доступ к данным, хранящимся в сервисе хранения данных Yandex Object Storage. При помощи соответствующих SQL запросов ответить на вопросы

## Шаги

### 1. Проверить доступность данных в Yandex Object Storage

Для этого воспользуемся HTTPs-запросами к нужному бакету

![](./images/image1.png)

Также можно воспользоваться языком R и функцией `s3_bucket` из пакета `arrow`:

```{r}
library(arrow)

bucket <- s3_bucket(
    bucket = "arrow-datasets",
    endpoint_override = "storage.yandexcloud.net",
    anonymous = TRUE
)

bucket$ls()
```

Видим, что в бакете присутствует нужный нам файл `yaqry_dataset.pqt`

### 2. Подключить бакет как источник данных для Yandex Query

Создаём соединение для публичного s3-хранилища:

![](./images/image2.png)

Также создаем првязку данных к нужному файлу из бакета:

![](./images/image3.png)

Укажем нужные типы данных столбцов:

![](./images/image4.png)

Попробуем получить данные через YQL:

![](./images/image5.png)

### Анализ

#### 1. Известно, что IP адреса внутренней сети начинаются с октетов, принадлежащих интервалу [12-14]. Определите количество хостов внутренней сети, представленных в датасете.

Для анализа воспользуемся регулярными выражениями:

```
SELECT COUNT(DISTINCT ipaddr) as ip_count
    FROM (
        SELECT src as ipaddr 
            FROM `frakenbok-data-binding` 
            WHERE src REGEXP '^1[2-4]\.'

        UNION ALL

        SELECT dst as ipaddr 
            FROM `frakenbok-data-binding` 
            WHERE src REGEXP '^"1[2-4]\.'
    )
```

![](./images/image6.png)

#### 2. Определите суммарный объем исходящего трафика

Исходящий трафик будем также искать по регулярным выражением. Источник должен быть внутренним хостом, а получатель - внешним:

```
SELECT SUM(bytes)
    FROM `frakenbok-data-binding` 
    WHERE 
        src REGEXP '^1[2-4]\.' AND
        dst NOT REGEXP '^1[2-4]\.'
```

![](./images/image7.png)

#### 3. Определите суммарный объем входящего трафика

Входящий трафик будем также искать по регулярным выражением. Источник должен быть внешним хостом, а получатель - внутренним:

```
SELECT SUM(bytes)
    FROM `frakenbok-data-binding` 
    WHERE 
        src NOT REGEXP '^1[2-4]\.' AND
        dst REGEXP '^1[2-4]\.'
```

![](./images/image8.png)

## Вывод

В данной работе мы научились анализу с помощью сервиса Yandex Query